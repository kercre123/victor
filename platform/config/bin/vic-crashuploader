#!/bin/sh
#
# platform/config/bin/vic-crashuploader
#
# Victor crash file uploader
#
# This script runs as a background to periodically check for written
# crash report files, upload them, and eventually delete them.
#
# Default configuration values may be overridden by environment.
# When run from vic-crashuploader.service, environment values may
# be set in /anki/etc/vic-crashuploader.env.
#

: ${VIC_CRASH_UPLOADER_KEEP_LATEST:=30}
: ${VIC_CRASH_FOLDER:="/data/data/com.anki.victor/cache/crashDumps"}
: ${VIC_CRASH_UPLOAD_URL:='https://anki.sp.backtrace.io:6098/post?format=minidump&token=6fd2bd053e8dd542ee97c05903b1ea068f090d37c7f6bbfa873c5f3b9c40b1d9'}
: ${VIC_CRASH_SCRAPE_PERIOD_SEC:=30}

UPLOADED_EXT=uploaded
LOCAL_EXT=local
mkdir -p $VIC_CRASH_FOLDER

# We don't want to upload crash dumps for a local build
# (since symbols aren't uploaded unless you do so manually)
: ${VIC_UPLOAD_CRASHES:=1}
# Determine if we're on a local build:
# Read /anki/etc/version file, parse "0.10.NNNNd", where NNNN is a build version, or 0 for local build
versionLine=$(head -n 1 /anki/etc/version)
lastField=${versionLine##*.}
buildNumber=${lastField//[!0-9]/}
if [ "$buildNumber" = "0" ]; then
  echo "Running LOCAL build; crashes will not be uploaded"
  VIC_UPLOAD_CRASHES=0
else
  echo "Running build number "$buildNumber
fi

#
# Collect some robot data
#
hostname=""
if [ -x /bin/hostname ]; then
  hostname="`/bin/hostname`"
fi

esn=""
if [ -x /bin/emr-cat ]; then
  esn=`/bin/emr-cat esn`""
fi

os_version=""
if [ -f /etc/os-version ]; then
  os_version="`/bin/cat /etc/os-version`"
fi

anki_version=""
if [ -f /anki/etc/version ]; then
  anki_version="`/bin/cat /anki/etc/version`"
fi

while :
do
    cd $VIC_CRASH_FOLDER > /dev/null

    # Go through all the crash files we haven't uploaded
    for i in ./*.dmp
    do
        # Ignore file if it is being held by any process; it's either one
        # of the empty crash dump files that exist while victor is running,
        # or is in the process of being written
        PROCESSES_HOLDING=$(fuser ${i})
        if [[ -z $PROCESSES_HOLDING ]]; then
            if [[ -s ${i} ]]; then
                if [ $VIC_UPLOAD_CRASHES -gt 0 ]; then
                    # If file size is greater than zero, attempt to upload it
                    echo "Uploading crash dump file ${i}"
                    #
                    # Upload crash dump plus metadata as multipart form
                    #
                    # TODO:  Remove -k after we get this to route through anki.com instead of directly to backtrace
                    #
                    form="-F upload_file=@${i}"
                    form="${form} -F hostname=${hostname}"
                    form="${form} -F robot.esn=${esn}"
                    form="${form} -F robot.os_version=${os_version}"
                    form="${form} -F robot.anki_version=${anki_version}"
                    if curl -k ${form} ${VIC_CRASH_UPLOAD_URL} ; then
                        echo "Successfully uploaded "$i

                        # Rename the file so that we can keep it around for a while before deletion
                        mv ${i} ${i}.$UPLOADED_EXT
                    else
                        echo "Failed to upload "$i
                    fi
                else
                    # Don't upload, but rename
                    echo "Renaming local build crash dump file {$i}"
                    mv ${i} ${i}.$LOCAL_EXT
                fi
            else
                # If file size is zero, at this point it has been abandoned
                echo "Deleting abandoned crash dump file ${i}"
                rm -f ${i}
            fi
        fi
    done

    # Now delete all but the oldest N crash files that have already been uploaded and/or renamed
    processed_files_total=$(ls -1 *.$UPLOADED_EXT *.$LOCAL_EXT 2>/dev/null | wc -l)
    if (( $processed_files_total > $VIC_CRASH_UPLOADER_KEEP_LATEST )); then
        num_files_to_delete=$(( $processed_files_total - $VIC_CRASH_UPLOADER_KEEP_LATEST ))
        echo "Deleting "$num_files_to_delete" crash dump file(s), but keeping the newest "$VIC_CRASH_UPLOADER_KEEP_LATEST" crash dump files"
        ls -1tr *.$UPLOADED_EXT *.$LOCAL_EXT| head -n$num_files_to_delete | xargs rm -f --
    fi

    sleep ${VIC_CRASH_SCRAPE_PERIOD_SEC}
done
